name: Claude CI Auto-Fix

# å½“ CI å¤±è´¥æ—¶è‡ªåŠ¨è§¦å‘ä¿®å¤
on:
  workflow_run:
    # ç›‘å¬æœ¬é¡¹ç›®çš„çœŸå® CI Workflow åç§°
    workflows: ["Dev Branch CI/CD", "Auto Release Pipeline", "PR Build Check"]
    types:
      - completed

permissions:
  contents: write          # åˆ›å»ºåˆ†æ”¯å’Œæäº¤ä»£ç 
  pull-requests: write     # åˆ›å»ºä¿®å¤ PR
  actions: read            # è¯»å– CI æ—¥å¿—
  issues: write            # è¯„è®ºé€šçŸ¥
  id-token: write          # OIDC è®¤è¯

jobs:
  auto-fix:
    # è§¦å‘æ¡ä»¶ï¼š
    # 1. CI å¤±è´¥
    # 2. å…³è”åˆ° PR
    # 3. ä¸æ˜¯ Claude è‡ªå·±åˆ›å»ºçš„ä¿®å¤åˆ†æ”¯ï¼ˆé¿å…å¾ªç¯ï¼‰
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.pull_requests[0] &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-ci-fix-')

    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Get CI failure details
        id: failure_details
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–å¤±è´¥çš„ Workflow Run è¯¦æƒ…
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            // è·å–æ‰€æœ‰ Jobs
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            // ç­›é€‰å¤±è´¥çš„ Jobs
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            // è·å–å¤±è´¥ Jobs çš„æ—¥å¿—
            let errorLogs = [];
            for (const job of failedJobs) {
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });

                // æå–æœ€å 5000 è¡Œæ—¥å¿—ï¼ˆé¿å…è¿‡é•¿ï¼‰
                const logLines = logs.data.split('\n');
                const relevantLogs = logLines.slice(-5000).join('\n');

                errorLogs.push({
                  jobName: job.name,
                  logs: relevantLogs
                });
              } catch (error) {
                console.log(`Failed to get logs for job ${job.name}: ${error.message}`);
              }
            }

            return {
              runUrl: run.data.html_url,
              workflowName: run.data.name,
              failedJobs: failedJobs.map(j => j.name),
              errorLogs: errorLogs,
              prNumber: ${{ github.event.workflow_run.pull_requests[0].number }},
              headBranch: '${{ github.event.workflow_run.head_branch }}'
            };

      - name: Fix CI failures with Claude
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            REPO: ${{ github.repository }}
            CI WORKFLOW: ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}
            FAILED RUN: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}
            PR NUMBER: ${{ fromJSON(steps.failure_details.outputs.result).prNumber }}
            BRANCH: ${{ fromJSON(steps.failure_details.outputs.result).headBranch }}
            FAILED JOBS: ${{ join(fromJSON(steps.failure_details.outputs.result).failedJobs, ', ') }}

            ## ä»»åŠ¡ï¼šè‡ªåŠ¨ä¿®å¤ CI å¤±è´¥

            CI æ„å»ºå¤±è´¥äº†ï¼Œè¯·åˆ†æé”™è¯¯æ—¥å¿—å¹¶å°è¯•è‡ªåŠ¨ä¿®å¤ã€‚

            ### é”™è¯¯æ—¥å¿—ï¼š
            ```
            ${{ toJSON(fromJSON(steps.failure_details.outputs.result).errorLogs) }}
            ```

            ### ä¿®å¤ç­–ç•¥ï¼š

            1. **åˆ†æé”™è¯¯ç±»å‹**ï¼š
               - ESLint/Prettier é”™è¯¯ â†’ è¿è¡Œ `npm run lint:fix` æˆ– `pnpm lint:fix`
               - TypeScript ç±»å‹é”™è¯¯ â†’ ä¿®å¤ç±»å‹å®šä¹‰
               - æµ‹è¯•å¤±è´¥ â†’ åˆ†æå¹¶ä¿®å¤æµ‹è¯•æˆ–ä»£ç 
               - æ„å»ºå¤±è´¥ â†’ æ£€æŸ¥ä¾èµ–å’Œé…ç½®

            2. **æ‰§è¡Œä¿®å¤**ï¼š
               - ä½¿ç”¨ Read å·¥å…·æŸ¥çœ‹ç›¸å…³æ–‡ä»¶
               - ä½¿ç”¨ Edit å·¥å…·ä¿®å¤é—®é¢˜
               - å¦‚æœæ˜¯æ ¼å¼åŒ–é—®é¢˜ï¼Œè¿è¡Œç›¸åº”çš„ lint/format å‘½ä»¤
               - ä½¿ç”¨ Bash(npm:*) æˆ– Bash(pnpm:*) è¿è¡Œä¿®å¤å‘½ä»¤

            3. **éªŒè¯ä¿®å¤**ï¼š
               - å¦‚æœå¯èƒ½ï¼Œè¿è¡Œç›¸å…³çš„æµ‹è¯•æˆ– lint å‘½ä»¤éªŒè¯ä¿®å¤
               - ç¡®ä¿ä¿®å¤ä¸ä¼šå¼•å…¥æ–°é—®é¢˜

            4. **æäº¤ä¿®å¤**ï¼š
               - ä½¿ç”¨ git å‘½ä»¤åˆ›å»ºæ–°åˆ†æ”¯ï¼š`claude-ci-fix-${{ fromJSON(steps.failure_details.outputs.result).prNumber }}-${{ github.run_id }}`
               - æäº¤ä¿®å¤ï¼š`git add . && git commit -m "fix: auto-fix CI failures in ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}"`
               - æ¨é€åˆ†æ”¯ï¼š`git push origin <branch-name>`
               - ä½¿ç”¨ `gh pr create` åˆ›å»º PRï¼ŒæŒ‡å‘åŸå§‹åˆ†æ”¯

            5. **PR æè¿°æ¨¡æ¿**ï¼š
               ```
               ## ğŸ¤– è‡ªåŠ¨ä¿®å¤ CI å¤±è´¥

               æ­¤ PR ç”± Claude AI è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºä¿®å¤ CI å¤±è´¥ã€‚

               **åŸå§‹ PR**: #${{ fromJSON(steps.failure_details.outputs.result).prNumber }}
               **å¤±è´¥çš„ CI**: [${{ fromJSON(steps.failure_details.outputs.result).workflowName }}](${{ fromJSON(steps.failure_details.outputs.result).runUrl }})
               **å¤±è´¥çš„ Jobs**: ${{ join(fromJSON(steps.failure_details.outputs.result).failedJobs, ', ') }}

               ### ä¿®å¤å†…å®¹ï¼š
               [æè¿°ä½ åšäº†ä»€ä¹ˆä¿®å¤]

               ### éªŒè¯ï¼š
               [è¯´æ˜å¦‚ä½•éªŒè¯ä¿®å¤æ˜¯å¦æœ‰æ•ˆ]

               ---
               ğŸ¤– ç”± Claude Code è‡ªåŠ¨ç”Ÿæˆ
               ```

            ### é‡è¦æç¤ºï¼š
            - åªä¿®å¤æ˜æ˜¾ä¸”å®‰å…¨çš„é—®é¢˜ï¼ˆlintã€æ ¼å¼åŒ–ã€ç®€å•ç±»å‹é”™è¯¯ï¼‰
            - å¦‚æœé”™è¯¯å¤æ‚æˆ–éœ€è¦ä¸šåŠ¡é€»è¾‘åˆ¤æ–­ï¼Œåœ¨ PR ä¸­è¯´æ˜æ— æ³•è‡ªåŠ¨ä¿®å¤
            - ç¡®ä¿ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½
            - æ‰€æœ‰ä¿®å¤éƒ½åº”è¯¥æ˜¯ä¿å®ˆå’Œå®‰å…¨çš„

          claude_args: |
            --max-turns 999
            --allowedTools "Read,Write,Edit,Bash(git:*),Bash(gh:*),Bash(npm:*),Bash(pnpm:*),Bash(yarn:*),Bash(bun:*),Bash(npx:*)"

          use_commit_signing: true
          # workflow_run äº‹ä»¶ä¸æ”¯æŒ track_progress,ç¦ç”¨ä»¥ç¡®ä¿æ­£å¸¸æ‰§è¡Œ
          track_progress: false
